"""Tests for vulnerability scanner."""

from pathlib import Path
from textwrap import dedent

import pytest


class TestVulnerabilityScanner:
    """Tests for VulnerabilityScanner class."""

    def test_scanner_creation(self, tmp_path: Path):
        """Test that VulnerabilityScanner can be created."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        scanner = VulnerabilityScanner(root_path=tmp_path)
        assert scanner is not None
        assert scanner.root_path == tmp_path

    def test_scanner_finds_python_files(self, tmp_path: Path):
        """Test that scanner discovers Python files."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        # Create test files
        (tmp_path / "main.py").write_text("print('hello')")
        (tmp_path / "test.txt").write_text("not python")
        subdir = tmp_path / "src"
        subdir.mkdir()
        (subdir / "app.py").write_text("print('app')")

        scanner = VulnerabilityScanner(root_path=tmp_path)
        files = scanner.discover_files()

        assert len(files) == 2
        assert all(f.suffix == ".py" for f in files)

    def test_scanner_ignores_pycache(self, tmp_path: Path):
        """Test that scanner ignores __pycache__ directories."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        # Create test files
        (tmp_path / "main.py").write_text("print('hello')")
        pycache = tmp_path / "__pycache__"
        pycache.mkdir()
        (pycache / "main.cpython-39.pyc").write_text("bytecode")

        scanner = VulnerabilityScanner(root_path=tmp_path)
        files = scanner.discover_files()

        assert len(files) == 1
        assert "__pycache__" not in str(files[0])

    def test_scanner_respects_extensions_filter(self, tmp_path: Path):
        """Test that scanner respects file extension filter."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        # Create test files
        (tmp_path / "app.py").write_text("python")
        (tmp_path / "app.js").write_text("javascript")
        (tmp_path / "style.css").write_text("css")

        scanner = VulnerabilityScanner(root_path=tmp_path, extensions=[".py", ".js"])
        files = scanner.discover_files()

        assert len(files) == 2
        extensions = {f.suffix for f in files}
        assert extensions == {".py", ".js"}


class TestPatternMatching:
    """Tests for pattern matching in files."""

    def test_find_matches_sql_injection(self, tmp_path: Path):
        """Test detection of SQL injection pattern."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        code = dedent('''
            def get_user(user_id):
                cursor.execute("SELECT * FROM users WHERE id = " + user_id)
        ''')
        (tmp_path / "db.py").write_text(code)

        scanner = VulnerabilityScanner(root_path=tmp_path)
        matches = scanner.scan_for_patterns(categories=["Tampering"])

        assert len(matches) > 0
        assert any("SQL" in m.pattern_name for m in matches)

    def test_find_matches_hardcoded_secret(self, tmp_path: Path):
        """Test detection of hardcoded secrets."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        code = dedent('''
            API_KEY = "sk-1234567890abcdef1234567890"
            password = "supersecret123"
        ''')
        (tmp_path / "config.py").write_text(code)

        scanner = VulnerabilityScanner(root_path=tmp_path)
        matches = scanner.scan_for_patterns(categories=["InfoDisclosure", "Spoofing"])

        assert len(matches) > 0

    def test_find_matches_returns_line_numbers(self, tmp_path: Path):
        """Test that matches include line numbers."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        code = dedent('''
            import os

            def run_command(cmd):
                os.system("ls " + cmd)
        ''')
        (tmp_path / "runner.py").write_text(code)

        scanner = VulnerabilityScanner(root_path=tmp_path)
        matches = scanner.scan_for_patterns(categories=["Tampering"])

        assert len(matches) > 0
        assert all(m.line_number > 0 for m in matches)

    def test_find_matches_returns_code_snippet(self, tmp_path: Path):
        """Test that matches include code snippets."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        code = "password = 'hardcoded123'"
        (tmp_path / "auth.py").write_text(code)

        scanner = VulnerabilityScanner(root_path=tmp_path)
        matches = scanner.scan_for_patterns(categories=["Spoofing"])

        assert len(matches) > 0
        assert all(len(m.code_snippet) > 0 for m in matches)

    def test_no_matches_for_safe_code(self, tmp_path: Path):
        """Test that safe code produces no matches."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        code = dedent('''
            def add(a, b):
                return a + b

            result = add(1, 2)
            print(result)
        ''')
        (tmp_path / "math.py").write_text(code)

        scanner = VulnerabilityScanner(root_path=tmp_path)
        matches = scanner.scan_for_patterns()

        assert len(matches) == 0


class TestPatternMatch:
    """Tests for PatternMatch dataclass."""

    def test_pattern_match_creation(self):
        """Test that PatternMatch can be created."""
        from securevibes_mcp.agents.vulnerability_scanner import PatternMatch

        match = PatternMatch(
            file_path=Path("/test/file.py"),
            line_number=10,
            code_snippet="password = 'secret'",
            pattern_name="Hardcoded Credentials",
            category="Spoofing",
            cwe_id="CWE-798",
            severity="critical",
        )
        assert match.file_path == Path("/test/file.py")
        assert match.line_number == 10
        assert match.category == "Spoofing"

    def test_pattern_match_has_all_fields(self):
        """Test that PatternMatch has all required fields."""
        from securevibes_mcp.agents.vulnerability_scanner import PatternMatch

        match = PatternMatch(
            file_path=Path("/test/file.py"),
            line_number=5,
            code_snippet="os.system(cmd)",
            pattern_name="Command Injection",
            category="Tampering",
            cwe_id="CWE-78",
            severity="critical",
        )
        assert match.file_path is not None
        assert match.line_number is not None
        assert match.code_snippet is not None
        assert match.pattern_name is not None
        assert match.category is not None
        assert match.cwe_id is not None
        assert match.severity is not None


class TestScanForCategory:
    """Tests for scanning specific STRIDE categories."""

    def test_scan_spoofing_category(self, tmp_path: Path):
        """Test scanning for Spoofing vulnerabilities."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        code = "verify = False  # Disable SSL verification"
        (tmp_path / "http.py").write_text(code)

        scanner = VulnerabilityScanner(root_path=tmp_path)
        matches = scanner.scan_for_patterns(categories=["Spoofing"])

        # Should find the disabled SSL verification
        assert len(matches) > 0
        assert all(m.category == "Spoofing" for m in matches)

    def test_scan_multiple_categories(self, tmp_path: Path):
        """Test scanning for multiple categories."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        code = dedent('''
            password = "secret123"
            DEBUG = True
        ''')
        (tmp_path / "config.py").write_text(code)

        scanner = VulnerabilityScanner(root_path=tmp_path)
        matches = scanner.scan_for_patterns(categories=["Spoofing", "InfoDisclosure"])

        assert len(matches) >= 2
        categories = {m.category for m in matches}
        assert len(categories) >= 1  # At least one category found

    def test_scan_all_categories_by_default(self, tmp_path: Path):
        """Test that scanning without category filter checks all."""
        from securevibes_mcp.agents.vulnerability_scanner import VulnerabilityScanner

        code = dedent('''
            password = "secret123"
            pickle.loads(data)
        ''')
        (tmp_path / "unsafe.py").write_text(code)

        scanner = VulnerabilityScanner(root_path=tmp_path)
        matches = scanner.scan_for_patterns()  # No category filter

        assert len(matches) >= 2
