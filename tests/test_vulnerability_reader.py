"""Tests for vulnerability reader."""

import json
from pathlib import Path

import pytest


class TestVulnerabilityReader:
    """Tests for VulnerabilityReader class."""

    def test_reader_creation(self, tmp_path: Path):
        """Test that VulnerabilityReader can be created."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        reader = VulnerabilityReader(root_path=tmp_path)
        assert reader is not None

    def test_reader_returns_none_when_missing(self, tmp_path: Path):
        """Test that reader returns None when artifact is missing."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        reader = VulnerabilityReader(root_path=tmp_path)
        data = reader.read()
        assert data is None

    def test_reader_parses_valid_artifact(self, tmp_path: Path):
        """Test that reader parses valid VULNERABILITIES.json."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        # Create artifact
        securevibes_dir = tmp_path / ".securevibes"
        securevibes_dir.mkdir()

        vuln_data = {
            "version": "1.0.0",
            "vulnerabilities": [
                {
                    "id": "VULN-001",
                    "threat_id": "THREAT-001",
                    "status": "confirmed",
                    "cwe_id": "CWE-89",
                    "severity": "critical",
                }
            ],
        }
        (securevibes_dir / "VULNERABILITIES.json").write_text(json.dumps(vuln_data))

        reader = VulnerabilityReader(root_path=tmp_path)
        data = reader.read()

        assert data is not None
        assert data["version"] == "1.0.0"
        assert len(data["vulnerabilities"]) == 1


class TestGetConfirmed:
    """Tests for getting confirmed vulnerabilities."""

    def test_get_confirmed_returns_only_confirmed(self, tmp_path: Path):
        """Test that get_confirmed returns only confirmed vulnerabilities."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        securevibes_dir = tmp_path / ".securevibes"
        securevibes_dir.mkdir()

        vuln_data = {
            "version": "1.0.0",
            "vulnerabilities": [
                {"id": "VULN-001", "status": "confirmed", "cwe_id": "CWE-89", "severity": "critical"},
                {"id": "VULN-002", "status": "not_confirmed", "cwe_id": None, "severity": "high"},
                {"id": "VULN-003", "status": "confirmed", "cwe_id": "CWE-79", "severity": "high"},
            ],
        }
        (securevibes_dir / "VULNERABILITIES.json").write_text(json.dumps(vuln_data))

        reader = VulnerabilityReader(root_path=tmp_path)
        confirmed = reader.get_confirmed()

        assert len(confirmed) == 2
        assert all(v["status"] == "confirmed" for v in confirmed)
        assert confirmed[0]["id"] == "VULN-001"
        assert confirmed[1]["id"] == "VULN-003"

    def test_get_confirmed_returns_empty_when_none_confirmed(self, tmp_path: Path):
        """Test that get_confirmed returns empty list when no confirmed vulns."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        securevibes_dir = tmp_path / ".securevibes"
        securevibes_dir.mkdir()

        vuln_data = {
            "version": "1.0.0",
            "vulnerabilities": [
                {"id": "VULN-001", "status": "not_confirmed", "cwe_id": None, "severity": "high"},
            ],
        }
        (securevibes_dir / "VULNERABILITIES.json").write_text(json.dumps(vuln_data))

        reader = VulnerabilityReader(root_path=tmp_path)
        confirmed = reader.get_confirmed()

        assert confirmed == []

    def test_get_confirmed_returns_empty_when_artifact_missing(self, tmp_path: Path):
        """Test that get_confirmed returns empty list when artifact missing."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        reader = VulnerabilityReader(root_path=tmp_path)
        confirmed = reader.get_confirmed()

        assert confirmed == []


class TestFilterByIds:
    """Tests for filtering vulnerabilities by ID."""

    def test_filter_by_ids(self, tmp_path: Path):
        """Test filtering vulnerabilities by specific IDs."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        securevibes_dir = tmp_path / ".securevibes"
        securevibes_dir.mkdir()

        vuln_data = {
            "version": "1.0.0",
            "vulnerabilities": [
                {"id": "VULN-001", "status": "confirmed", "cwe_id": "CWE-89", "severity": "critical"},
                {"id": "VULN-002", "status": "confirmed", "cwe_id": "CWE-79", "severity": "high"},
                {"id": "VULN-003", "status": "confirmed", "cwe_id": "CWE-78", "severity": "critical"},
            ],
        }
        (securevibes_dir / "VULNERABILITIES.json").write_text(json.dumps(vuln_data))

        reader = VulnerabilityReader(root_path=tmp_path)
        filtered = reader.filter_by_ids(["VULN-001", "VULN-003"])

        assert len(filtered) == 2
        assert filtered[0]["id"] == "VULN-001"
        assert filtered[1]["id"] == "VULN-003"

    def test_filter_by_ids_empty_list_returns_all(self, tmp_path: Path):
        """Test that empty filter list returns all vulnerabilities."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        securevibes_dir = tmp_path / ".securevibes"
        securevibes_dir.mkdir()

        vuln_data = {
            "version": "1.0.0",
            "vulnerabilities": [
                {"id": "VULN-001", "status": "confirmed", "cwe_id": "CWE-89", "severity": "critical"},
                {"id": "VULN-002", "status": "confirmed", "cwe_id": "CWE-79", "severity": "high"},
            ],
        }
        (securevibes_dir / "VULNERABILITIES.json").write_text(json.dumps(vuln_data))

        reader = VulnerabilityReader(root_path=tmp_path)
        filtered = reader.filter_by_ids([])

        assert len(filtered) == 2

    def test_filter_by_ids_none_returns_all(self, tmp_path: Path):
        """Test that None filter returns all vulnerabilities."""
        from securevibes_mcp.agents.vulnerability_reader import VulnerabilityReader

        securevibes_dir = tmp_path / ".securevibes"
        securevibes_dir.mkdir()

        vuln_data = {
            "version": "1.0.0",
            "vulnerabilities": [
                {"id": "VULN-001", "status": "confirmed", "cwe_id": "CWE-89", "severity": "critical"},
            ],
        }
        (securevibes_dir / "VULNERABILITIES.json").write_text(json.dumps(vuln_data))

        reader = VulnerabilityReader(root_path=tmp_path)
        filtered = reader.filter_by_ids(None)

        assert len(filtered) == 1
