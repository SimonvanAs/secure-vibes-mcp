"""Tests for vulnerability builder and output generator."""

from pathlib import Path

import pytest


class TestVulnerability:
    """Tests for Vulnerability dataclass."""

    def test_vulnerability_creation(self):
        """Test that Vulnerability can be created."""
        from securevibes_mcp.agents.vulnerability_builder import Vulnerability

        vuln = Vulnerability(
            id="VULN-001",
            threat_id="THREAT-001",
            status="confirmed",
            file_path="/test/file.py",
            line_number=10,
            code_snippet="password = 'secret'",
            cwe_id="CWE-798",
            severity="critical",
            description="Hardcoded credentials in source code",
        )
        assert vuln.id == "VULN-001"
        assert vuln.threat_id == "THREAT-001"
        assert vuln.status == "confirmed"

    def test_vulnerability_has_all_fields(self):
        """Test that Vulnerability has all required fields."""
        from securevibes_mcp.agents.vulnerability_builder import Vulnerability

        vuln = Vulnerability(
            id="VULN-002",
            threat_id="THREAT-002",
            status="not_confirmed",
            file_path=None,
            line_number=None,
            code_snippet=None,
            cwe_id=None,
            severity="medium",
            description="No code evidence found",
        )
        assert vuln.id is not None
        assert vuln.threat_id is not None
        assert vuln.status is not None
        assert vuln.severity is not None

    def test_vulnerability_to_dict(self):
        """Test that Vulnerability can be converted to dict."""
        from securevibes_mcp.agents.vulnerability_builder import Vulnerability

        vuln = Vulnerability(
            id="VULN-001",
            threat_id="THREAT-001",
            status="confirmed",
            file_path="/test/file.py",
            line_number=10,
            code_snippet="password = 'secret'",
            cwe_id="CWE-798",
            severity="critical",
            description="Hardcoded credentials",
        )
        d = vuln.to_dict()

        assert d["id"] == "VULN-001"
        assert d["threat_id"] == "THREAT-001"
        assert d["status"] == "confirmed"
        assert d["file_path"] == "/test/file.py"


class TestVulnerabilityBuilder:
    """Tests for VulnerabilityBuilder class."""

    def test_builder_creation(self):
        """Test that VulnerabilityBuilder can be created."""
        from securevibes_mcp.agents.vulnerability_builder import VulnerabilityBuilder

        builder = VulnerabilityBuilder()
        assert builder is not None

    def test_builder_generates_unique_ids(self):
        """Test that builder generates unique sequential IDs."""
        from securevibes_mcp.agents.vulnerability_builder import VulnerabilityBuilder

        builder = VulnerabilityBuilder()
        id1 = builder._next_id()
        id2 = builder._next_id()
        id3 = builder._next_id()

        assert id1 == "VULN-001"
        assert id2 == "VULN-002"
        assert id3 == "VULN-003"

    def test_builder_creates_confirmed_vulnerability(self):
        """Test creating a confirmed vulnerability from a match."""
        from securevibes_mcp.agents.vulnerability_builder import VulnerabilityBuilder
        from securevibes_mcp.agents.vulnerability_scanner import PatternMatch

        match = PatternMatch(
            file_path=Path("/test/file.py"),
            line_number=10,
            code_snippet="password = 'secret'",
            pattern_name="Hardcoded Credentials",
            category="Spoofing",
            cwe_id="CWE-798",
            severity="critical",
        )

        builder = VulnerabilityBuilder()
        vuln = builder.from_match(match, threat_id="THREAT-001")

        assert vuln.id == "VULN-001"
        assert vuln.threat_id == "THREAT-001"
        assert vuln.status == "confirmed"
        assert vuln.file_path == "/test/file.py"
        assert vuln.line_number == 10
        assert vuln.cwe_id == "CWE-798"

    def test_builder_creates_not_confirmed_vulnerability(self):
        """Test creating a not_confirmed vulnerability for unmatched threat."""
        from securevibes_mcp.agents.vulnerability_builder import VulnerabilityBuilder

        builder = VulnerabilityBuilder()
        vuln = builder.not_confirmed(
            threat_id="THREAT-005",
            category="DoS",
            severity="medium",
            description="No code evidence found for DoS threat",
        )

        assert vuln.id == "VULN-001"
        assert vuln.threat_id == "THREAT-005"
        assert vuln.status == "not_confirmed"
        assert vuln.file_path is None
        assert vuln.line_number is None
        assert vuln.code_snippet is None


class TestThreatStatusTracking:
    """Tests for tracking threat confirmation status."""

    def test_track_confirmed_threats(self):
        """Test tracking which threats have confirmed vulnerabilities."""
        from securevibes_mcp.agents.vulnerability_builder import VulnerabilityBuilder
        from securevibes_mcp.agents.vulnerability_scanner import PatternMatch

        match = PatternMatch(
            file_path=Path("/test/file.py"),
            line_number=10,
            code_snippet="password = 'secret'",
            pattern_name="Hardcoded Credentials",
            category="Spoofing",
            cwe_id="CWE-798",
            severity="critical",
        )

        builder = VulnerabilityBuilder()
        builder.from_match(match, threat_id="THREAT-001")

        assert "THREAT-001" in builder.confirmed_threats

    def test_all_threats_included_in_output(self):
        """Test that all threats appear in output regardless of status."""
        from securevibes_mcp.agents.vulnerability_builder import VulnerabilityBuilder
        from securevibes_mcp.agents.vulnerability_scanner import PatternMatch

        match = PatternMatch(
            file_path=Path("/test/file.py"),
            line_number=10,
            code_snippet="password = 'secret'",
            pattern_name="Hardcoded Credentials",
            category="Spoofing",
            cwe_id="CWE-798",
            severity="critical",
        )

        threats = [
            {"id": "THREAT-001", "category": "Spoofing", "severity": "critical"},
            {"id": "THREAT-002", "category": "DoS", "severity": "medium"},
        ]

        builder = VulnerabilityBuilder()
        # Only first threat has a match
        builder.from_match(match, threat_id="THREAT-001")

        vulnerabilities = builder.build_all(threats)

        assert len(vulnerabilities) == 2
        assert vulnerabilities[0].status == "confirmed"
        assert vulnerabilities[1].status == "not_confirmed"


class TestVulnerabilityOutput:
    """Tests for VULNERABILITIES.json output generation."""

    def test_output_to_json(self):
        """Test generating JSON output."""
        from securevibes_mcp.agents.vulnerability_builder import (
            Vulnerability,
            VulnerabilityOutput,
        )

        vulns = [
            Vulnerability(
                id="VULN-001",
                threat_id="THREAT-001",
                status="confirmed",
                file_path="/test/file.py",
                line_number=10,
                code_snippet="password = 'secret'",
                cwe_id="CWE-798",
                severity="critical",
                description="Hardcoded credentials",
            ),
            Vulnerability(
                id="VULN-002",
                threat_id="THREAT-002",
                status="not_confirmed",
                file_path=None,
                line_number=None,
                code_snippet=None,
                cwe_id=None,
                severity="medium",
                description="No code evidence",
            ),
        ]

        output = VulnerabilityOutput(vulnerabilities=vulns)
        json_str = output.to_json()

        assert '"version":' in json_str
        assert '"vulnerabilities":' in json_str
        assert '"VULN-001"' in json_str
        assert '"VULN-002"' in json_str

    def test_output_includes_summary(self):
        """Test that output includes summary statistics."""
        from securevibes_mcp.agents.vulnerability_builder import (
            Vulnerability,
            VulnerabilityOutput,
        )

        vulns = [
            Vulnerability(
                id="VULN-001",
                threat_id="THREAT-001",
                status="confirmed",
                file_path="/test/file.py",
                line_number=10,
                code_snippet="code",
                cwe_id="CWE-798",
                severity="critical",
                description="desc",
            ),
            Vulnerability(
                id="VULN-002",
                threat_id="THREAT-002",
                status="confirmed",
                file_path="/test/file2.py",
                line_number=20,
                code_snippet="code",
                cwe_id="CWE-89",
                severity="high",
                description="desc",
            ),
            Vulnerability(
                id="VULN-003",
                threat_id="THREAT-003",
                status="not_confirmed",
                file_path=None,
                line_number=None,
                code_snippet=None,
                cwe_id=None,
                severity="medium",
                description="desc",
            ),
        ]

        output = VulnerabilityOutput(vulnerabilities=vulns)
        summary = output.get_summary()

        assert summary["total_threats"] == 3
        assert summary["confirmed"] == 2
        assert summary["not_confirmed"] == 1
        assert summary["by_severity"]["critical"] == 1
        assert summary["by_severity"]["high"] == 1

    def test_output_to_dict(self):
        """Test converting output to dictionary."""
        from securevibes_mcp.agents.vulnerability_builder import (
            Vulnerability,
            VulnerabilityOutput,
        )

        vulns = [
            Vulnerability(
                id="VULN-001",
                threat_id="THREAT-001",
                status="confirmed",
                file_path="/test/file.py",
                line_number=10,
                code_snippet="code",
                cwe_id="CWE-798",
                severity="critical",
                description="desc",
            ),
        ]

        output = VulnerabilityOutput(vulnerabilities=vulns)
        d = output.to_dict()

        assert "version" in d
        assert "vulnerabilities" in d
        assert "summary" in d
        assert len(d["vulnerabilities"]) == 1
