"""Tests for vulnerability pattern registry."""

import re


class TestVulnerabilityPattern:
    """Tests for VulnerabilityPattern dataclass."""

    def test_pattern_creation(self):
        """Test that VulnerabilityPattern can be created."""
        from securevibes_mcp.agents.vulnerability_patterns import VulnerabilityPattern

        pattern = VulnerabilityPattern(
            name="SQL Injection",
            pattern=r"execute\s*\(",
            category="Tampering",
            cwe_id="CWE-89",
            description="SQL injection vulnerability",
            severity="critical",
        )
        assert pattern.name == "SQL Injection"
        assert pattern.category == "Tampering"
        assert pattern.cwe_id == "CWE-89"

    def test_pattern_has_all_fields(self):
        """Test that VulnerabilityPattern has all required fields."""
        from securevibes_mcp.agents.vulnerability_patterns import VulnerabilityPattern

        pattern = VulnerabilityPattern(
            name="Hardcoded Secret",
            pattern=r"password\s*=\s*['\"]",
            category="InfoDisclosure",
            cwe_id="CWE-798",
            description="Hardcoded credentials in source",
            severity="high",
        )
        assert pattern.name is not None
        assert pattern.pattern is not None
        assert pattern.category is not None
        assert pattern.cwe_id is not None
        assert pattern.description is not None
        assert pattern.severity is not None

    def test_pattern_is_valid_regex(self):
        """Test that pattern field is a valid regex."""
        from securevibes_mcp.agents.vulnerability_patterns import VulnerabilityPattern

        pattern = VulnerabilityPattern(
            name="Command Injection",
            pattern=r"subprocess\.call\s*\(\s*[^,\]]+\s*\+",
            category="Tampering",
            cwe_id="CWE-78",
            description="Command injection via subprocess",
            severity="critical",
        )
        # Should compile without error
        compiled = re.compile(pattern.pattern)
        assert compiled is not None


class TestPatternRegistry:
    """Tests for PatternRegistry."""

    def test_registry_creation(self):
        """Test that PatternRegistry can be created."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        assert registry is not None

    def test_registry_has_spoofing_patterns(self):
        """Test that registry has patterns for Spoofing category."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        patterns = registry.get_patterns_for_category("Spoofing")

        assert len(patterns) > 0
        assert all(p.category == "Spoofing" for p in patterns)

    def test_registry_has_tampering_patterns(self):
        """Test that registry has patterns for Tampering category."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        patterns = registry.get_patterns_for_category("Tampering")

        assert len(patterns) > 0
        assert all(p.category == "Tampering" for p in patterns)

    def test_registry_has_repudiation_patterns(self):
        """Test that registry has patterns for Repudiation category."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        patterns = registry.get_patterns_for_category("Repudiation")

        assert len(patterns) > 0
        assert all(p.category == "Repudiation" for p in patterns)

    def test_registry_has_info_disclosure_patterns(self):
        """Test that registry has patterns for InfoDisclosure category."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        patterns = registry.get_patterns_for_category("InfoDisclosure")

        assert len(patterns) > 0
        assert all(p.category == "InfoDisclosure" for p in patterns)

    def test_registry_has_dos_patterns(self):
        """Test that registry has patterns for DoS category."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        patterns = registry.get_patterns_for_category("DoS")

        assert len(patterns) > 0
        assert all(p.category == "DoS" for p in patterns)

    def test_registry_has_eop_patterns(self):
        """Test that registry has patterns for EoP category."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        patterns = registry.get_patterns_for_category("EoP")

        assert len(patterns) > 0
        assert all(p.category == "EoP" for p in patterns)

    def test_registry_returns_empty_for_unknown_category(self):
        """Test that registry returns empty list for unknown category."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        patterns = registry.get_patterns_for_category("Unknown")

        assert patterns == []

    def test_get_all_patterns(self):
        """Test getting all patterns from registry."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        all_patterns = registry.get_all_patterns()

        assert len(all_patterns) > 0
        # Should have patterns for all STRIDE categories
        categories = {p.category for p in all_patterns}
        assert len(categories) == 6

    def test_all_patterns_have_valid_regex(self):
        """Test that all patterns in registry are valid regex."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        for pattern in registry.get_all_patterns():
            # Should compile without raising exception
            compiled = re.compile(pattern.pattern)
            assert compiled is not None

    def test_all_patterns_have_cwe_id(self):
        """Test that all patterns have a CWE ID."""
        from securevibes_mcp.agents.vulnerability_patterns import PatternRegistry

        registry = PatternRegistry()
        for pattern in registry.get_all_patterns():
            assert pattern.cwe_id.startswith("CWE-")


class TestCWEMapping:
    """Tests for CWE ID mappings."""

    def test_cwe_mapping_exists(self):
        """Test that CWE_DESCRIPTIONS mapping exists."""
        from securevibes_mcp.agents.vulnerability_patterns import CWE_DESCRIPTIONS

        assert CWE_DESCRIPTIONS is not None
        assert len(CWE_DESCRIPTIONS) > 0

    def test_cwe_mapping_has_common_ids(self):
        """Test that common CWE IDs are mapped."""
        from securevibes_mcp.agents.vulnerability_patterns import CWE_DESCRIPTIONS

        # Common CWE IDs that should be present
        assert "CWE-89" in CWE_DESCRIPTIONS  # SQL Injection
        assert "CWE-78" in CWE_DESCRIPTIONS  # Command Injection
        assert "CWE-79" in CWE_DESCRIPTIONS  # XSS
        assert "CWE-798" in CWE_DESCRIPTIONS  # Hardcoded Credentials

    def test_get_cwe_description(self):
        """Test getting CWE description from mapping."""
        from securevibes_mcp.agents.vulnerability_patterns import get_cwe_description

        description = get_cwe_description("CWE-89")
        assert description is not None
        assert len(description) > 0

    def test_get_cwe_description_unknown(self):
        """Test getting description for unknown CWE ID."""
        from securevibes_mcp.agents.vulnerability_patterns import get_cwe_description

        description = get_cwe_description("CWE-99999")
        assert description == "Unknown vulnerability type"
