"""VULNERABILITIES.json reader for the DAST Agent."""

import json
from pathlib import Path
from typing import Any

from securevibes_mcp.storage import ScanStateManager


class VulnerabilityReader:
    """Reader for loading and parsing VULNERABILITIES.json artifacts.

    Uses ScanStateManager to read the vulnerabilities from the project's
    .securevibes directory.
    """

    ARTIFACT_NAME = "VULNERABILITIES.json"

    def __init__(self, root_path: Path) -> None:
        """Initialize the reader.

        Args:
            root_path: Root path of the project.
        """
        self.root_path = root_path
        self.storage = ScanStateManager(root_path)

    def read(self) -> dict[str, Any] | None:
        """Read the VULNERABILITIES.json artifact.

        Returns:
            Parsed JSON content as dictionary, or None if not found or invalid.
        """
        content = self.storage.read_artifact(self.ARTIFACT_NAME)
        if content is None:
            return None

        try:
            return json.loads(content)
        except json.JSONDecodeError:
            return None

    def get_confirmed(self) -> list[dict[str, Any]]:
        """Get only confirmed vulnerabilities.

        Returns:
            List of vulnerability dicts with status == "confirmed".
        """
        data = self.read()
        if data is None:
            return []

        vulnerabilities = data.get("vulnerabilities", [])
        return [v for v in vulnerabilities if v.get("status") == "confirmed"]

    def filter_by_ids(
        self,
        ids: list[str] | None,
    ) -> list[dict[str, Any]]:
        """Filter vulnerabilities by specific IDs.

        Args:
            ids: List of vulnerability IDs to include. If None or empty,
                returns all vulnerabilities.

        Returns:
            List of vulnerability dicts matching the filter.
        """
        data = self.read()
        if data is None:
            return []

        vulnerabilities = data.get("vulnerabilities", [])

        if not ids:
            return vulnerabilities

        id_set = set(ids)
        return [v for v in vulnerabilities if v.get("id") in id_set]
