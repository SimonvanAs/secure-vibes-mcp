"""Vulnerability builder and output generator for code review.

Builds structured vulnerability findings from pattern matches and threat
entries, generating VULNERABILITIES.json output with status tracking.
"""

import json
from dataclasses import dataclass, field
from datetime import datetime, timezone
from pathlib import Path
from typing import Any

from securevibes_mcp.agents.vulnerability_patterns import get_cwe_description
from securevibes_mcp.agents.vulnerability_scanner import PatternMatch


@dataclass
class Vulnerability:
    """A vulnerability finding from code review.

    Attributes:
        id: Unique vulnerability identifier (e.g., VULN-001).
        threat_id: Reference to originating threat from THREAT_MODEL.json.
        status: "confirmed" (code evidence found) or "not_confirmed".
        file_path: Absolute path to affected file (None if not_confirmed).
        line_number: Line number of vulnerable code (None if not_confirmed).
        code_snippet: Relevant code excerpt (None if not_confirmed).
        cwe_id: Common Weakness Enumeration identifier.
        severity: Severity level (critical, high, medium, low).
        description: Human-readable description of the vulnerability.
    """

    id: str
    threat_id: str
    status: str
    file_path: str | None
    line_number: int | None
    code_snippet: str | None
    cwe_id: str | None
    severity: str
    description: str

    def to_dict(self) -> dict[str, Any]:
        """Convert vulnerability to dictionary.

        Returns:
            Dictionary representation of the vulnerability.
        """
        return {
            "id": self.id,
            "threat_id": self.threat_id,
            "status": self.status,
            "file_path": self.file_path,
            "line_number": self.line_number,
            "code_snippet": self.code_snippet,
            "cwe_id": self.cwe_id,
            "severity": self.severity,
            "description": self.description,
        }


class VulnerabilityBuilder:
    """Builds vulnerability findings from pattern matches and threats.

    Generates unique vulnerability IDs and tracks which threats have
    confirmed code evidence.
    """

    def __init__(self) -> None:
        """Initialize the builder."""
        self._counter = 0
        self._vulnerabilities: list[Vulnerability] = []
        self.confirmed_threats: set[str] = set()

    def _next_id(self) -> str:
        """Generate the next unique vulnerability ID.

        Returns:
            Unique ID in format VULN-NNN.
        """
        self._counter += 1
        return f"VULN-{self._counter:03d}"

    def from_match(
        self,
        match: PatternMatch,
        threat_id: str,
    ) -> Vulnerability:
        """Create a confirmed vulnerability from a pattern match.

        Args:
            match: The pattern match from scanning.
            threat_id: The threat ID this vulnerability confirms.

        Returns:
            A confirmed Vulnerability object.
        """
        cwe_desc = get_cwe_description(match.cwe_id)
        description = f"{match.pattern_name}: {cwe_desc}"

        vuln = Vulnerability(
            id=self._next_id(),
            threat_id=threat_id,
            status="confirmed",
            file_path=str(match.file_path),
            line_number=match.line_number,
            code_snippet=match.code_snippet,
            cwe_id=match.cwe_id,
            severity=match.severity,
            description=description,
        )

        self._vulnerabilities.append(vuln)
        self.confirmed_threats.add(threat_id)
        return vuln

    def not_confirmed(
        self,
        threat_id: str,
        category: str,
        severity: str,
        description: str | None = None,
    ) -> Vulnerability:
        """Create a not_confirmed vulnerability for an unmatched threat.

        Args:
            threat_id: The threat ID that had no code evidence.
            category: STRIDE category of the threat.
            severity: Severity level of the threat.
            description: Optional description (defaults to generic message).

        Returns:
            A not_confirmed Vulnerability object.
        """
        if description is None:
            description = f"No code evidence found for {category} threat"

        vuln = Vulnerability(
            id=self._next_id(),
            threat_id=threat_id,
            status="not_confirmed",
            file_path=None,
            line_number=None,
            code_snippet=None,
            cwe_id=None,
            severity=severity,
            description=description,
        )

        self._vulnerabilities.append(vuln)
        return vuln

    def build_all(
        self,
        threats: list[dict[str, Any]],
    ) -> list[Vulnerability]:
        """Build final vulnerability list including all threats.

        Creates not_confirmed entries for threats without code evidence.

        Args:
            threats: List of threat entries from THREAT_MODEL.json.

        Returns:
            Complete list of Vulnerability objects.
        """
        # Add not_confirmed for threats without matches
        for threat in threats:
            threat_id = threat["id"]
            if threat_id not in self.confirmed_threats:
                self.not_confirmed(
                    threat_id=threat_id,
                    category=threat.get("category", "Unknown"),
                    severity=threat.get("severity", "medium"),
                )

        return self._vulnerabilities


@dataclass
class VulnerabilityOutput:
    """Output generator for VULNERABILITIES.json.

    Handles serialization and summary statistics for vulnerability findings.
    """

    vulnerabilities: list[Vulnerability] = field(default_factory=list)
    version: str = "1.0.0"

    def get_summary(self) -> dict[str, Any]:
        """Generate summary statistics.

        Returns:
            Dictionary with summary statistics.
        """
        confirmed = [v for v in self.vulnerabilities if v.status == "confirmed"]
        not_confirmed = [v for v in self.vulnerabilities if v.status == "not_confirmed"]

        by_severity: dict[str, int] = {}
        by_cwe: dict[str, int] = {}

        for vuln in confirmed:
            by_severity[vuln.severity] = by_severity.get(vuln.severity, 0) + 1
            if vuln.cwe_id:
                by_cwe[vuln.cwe_id] = by_cwe.get(vuln.cwe_id, 0) + 1

        return {
            "total_threats": len(self.vulnerabilities),
            "confirmed": len(confirmed),
            "not_confirmed": len(not_confirmed),
            "by_severity": by_severity,
            "by_cwe": by_cwe,
        }

    def to_dict(self) -> dict[str, Any]:
        """Convert output to dictionary.

        Returns:
            Dictionary representation of the full output.
        """
        return {
            "version": self.version,
            "generated_at": datetime.now(timezone.utc).isoformat(),
            "vulnerabilities": [v.to_dict() for v in self.vulnerabilities],
            "summary": self.get_summary(),
        }

    def to_json(self, indent: int = 2) -> str:
        """Serialize output to JSON string.

        Args:
            indent: JSON indentation level.

        Returns:
            JSON string representation.
        """
        return json.dumps(self.to_dict(), indent=indent)
