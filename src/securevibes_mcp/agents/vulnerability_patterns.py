"""Vulnerability patterns for code review analysis.

Maps STRIDE threat categories to concrete vulnerability patterns
that can be detected through static code analysis.
"""

from dataclasses import dataclass


@dataclass
class VulnerabilityPattern:
    """A pattern for detecting vulnerabilities in code.

    Attributes:
        name: Human-readable name for the vulnerability type.
        pattern: Regex pattern to match in source code.
        category: STRIDE category this pattern detects.
        cwe_id: Common Weakness Enumeration identifier.
        description: Description of the vulnerability.
        severity: Severity level (critical, high, medium, low).
    """

    name: str
    pattern: str
    category: str
    cwe_id: str
    description: str
    severity: str


# CWE ID to description mapping
CWE_DESCRIPTIONS: dict[str, str] = {
    "CWE-22": "Improper Limitation of a Pathname to a Restricted Directory",
    "CWE-78": "Improper Neutralization of Special Elements used in an OS Command",
    "CWE-79": "Improper Neutralization of Input During Web Page Generation (XSS)",
    "CWE-89": "Improper Neutralization of Special Elements used in an SQL Command",
    "CWE-90": "Improper Neutralization of Special Elements used in an LDAP Query",
    "CWE-94": "Improper Control of Generation of Code",
    "CWE-117": "Improper Output Neutralization for Logs",
    "CWE-185": "Incorrect Regular Expression",
    "CWE-208": "Observable Timing Discrepancy",
    "CWE-209": "Generation of Error Message Containing Sensitive Information",
    "CWE-215": "Insertion of Sensitive Information Into Debugging Code",
    "CWE-250": "Execution with Unnecessary Privileges",
    "CWE-259": "Use of Hard-coded Password",
    "CWE-284": "Improper Access Control",
    "CWE-287": "Improper Authentication",
    "CWE-295": "Improper Certificate Validation",
    "CWE-306": "Missing Authentication for Critical Function",
    "CWE-312": "Cleartext Storage of Sensitive Information",
    "CWE-327": "Use of a Broken or Risky Cryptographic Algorithm",
    "CWE-330": "Use of Insufficiently Random Values",
    "CWE-347": "Improper Verification of Cryptographic Signature",
    "CWE-352": "Cross-Site Request Forgery (CSRF)",
    "CWE-400": "Uncontrolled Resource Consumption",
    "CWE-502": "Deserialization of Untrusted Data",
    "CWE-532": "Insertion of Sensitive Information into Log File",
    "CWE-547": "Use of Hard-coded, Security-relevant Constants",
    "CWE-601": "URL Redirection to Untrusted Site",
    "CWE-611": "Improper Restriction of XML External Entity Reference",
    "CWE-614": "Sensitive Cookie in HTTPS Session Without 'Secure' Attribute",
    "CWE-676": "Use of Potentially Dangerous Function",
    "CWE-732": "Incorrect Permission Assignment for Critical Resource",
    "CWE-770": "Allocation of Resources Without Limits or Throttling",
    "CWE-778": "Insufficient Logging",
    "CWE-798": "Use of Hard-coded Credentials",
    "CWE-862": "Missing Authorization",
    "CWE-915": "Improperly Controlled Modification of Dynamically-Determined Object Attributes",
    "CWE-918": "Server-Side Request Forgery (SSRF)",
    "CWE-943": "Improper Neutralization of Special Elements in Data Query Logic",
    "CWE-1004": "Sensitive Cookie Without 'HttpOnly' Flag",
    "CWE-1021": "Improper Restriction of Rendered UI Layers or Frames",
    "CWE-1275": "Sensitive Cookie with Improper SameSite Attribute",
    "CWE-1333": "Inefficient Regular Expression Complexity",
}


def get_cwe_description(cwe_id: str) -> str:
    """Get the description for a CWE ID.

    Args:
        cwe_id: The CWE identifier (e.g., "CWE-89").

    Returns:
        Description of the CWE, or default message if unknown.
    """
    return CWE_DESCRIPTIONS.get(cwe_id, "Unknown vulnerability type")


# Spoofing patterns - authentication bypass, weak credential handling
SPOOFING_PATTERNS: list[VulnerabilityPattern] = [
    VulnerabilityPattern(
        name="Hardcoded Credentials",
        pattern=r"(?:password|passwd|pwd|secret|api_key|apikey|token)\s*=\s*['\"][^'\"]+['\"]",
        category="Spoofing",
        cwe_id="CWE-798",
        description="Hardcoded credentials in source code",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Weak Password Comparison",
        pattern=r"(?:password|passwd)\s*==\s*",
        category="Spoofing",
        cwe_id="CWE-287",
        description="Direct password comparison without secure hashing",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Disabled SSL Verification",
        pattern=r"verify\s*=\s*False|CERT_NONE|check_hostname\s*=\s*False",
        category="Spoofing",
        cwe_id="CWE-295",
        description="SSL/TLS certificate verification disabled",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Missing Authentication Check",
        pattern=r"@app\.route\([^)]+\)\s*\n\s*def\s+\w+\([^)]*\):\s*\n(?!\s*@login_required|\s*@auth|\s*if.*authenticated)",
        category="Spoofing",
        cwe_id="CWE-306",
        description="Route handler without authentication check",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Insecure Random for Security",
        pattern=r"(?:random\.random|random\.randint|random\.choice|random\.randrange)\s*\([^)]*\).*(?:token|secret|password|key|salt|nonce|session|csrf)",
        category="Spoofing",
        cwe_id="CWE-330",
        description="Insecure random number generator used for security purposes",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Weak Token Generation",
        pattern=r"(?:token|secret|key|session_id)\s*=\s*['\"]?(?:random\.|str\(random\.)",
        category="Spoofing",
        cwe_id="CWE-330",
        description="Weak random source used for token generation",
        severity="high",
    ),
    VulnerabilityPattern(
        name="JWT Verification Disabled",
        pattern=r"jwt\.decode\s*\([^)]*(?:verify\s*=\s*False|options\s*=\s*\{[^}]*verify[^}]*False)",
        category="Spoofing",
        cwe_id="CWE-347",
        description="JWT signature verification disabled",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="JWT Algorithm None",
        pattern=r"jwt\.(?:decode|encode)\s*\([^)]*algorithm\s*=\s*['\"]none['\"]",
        category="Spoofing",
        cwe_id="CWE-347",
        description="JWT using algorithm 'none' - no signature verification",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Timing Attack Vulnerable",
        pattern=r"(?:password|token|secret|key|hash)\s*==\s*(?!hmac\.compare_digest)",
        category="Spoofing",
        cwe_id="CWE-208",
        description="Non-constant-time comparison of secrets",
        severity="medium",
    ),
]

# Tampering patterns - SQL injection, command injection, path traversal, XSS
TAMPERING_PATTERNS: list[VulnerabilityPattern] = [
    VulnerabilityPattern(
        name="SQL Injection",
        pattern=r"(?:execute|cursor\.execute|\.query)\s*\(\s*f['\"]|(?:execute|cursor\.execute|\.query)\s*\([^)]*(?:%s|\.format|\+\s*\w)",
        category="Tampering",
        cwe_id="CWE-89",
        description="SQL query constructed with string concatenation or formatting",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Command Injection",
        pattern=r"(?:os\.system|subprocess\.call|subprocess\.run|subprocess\.Popen)\s*\(\s*f['\"]|(?:os\.system|subprocess\.call|subprocess\.run|subprocess\.Popen|shell\s*=\s*True)\s*\([^)]*(?:\+\s*\w|\.format|%s)",
        category="Tampering",
        cwe_id="CWE-78",
        description="Shell command constructed with user input",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Path Traversal",
        pattern=r"(?:open)\s*\(\s*f['\"]|(?:open|read|write|load|save)\s*\([^)]*(?:\+\s*\w|\.format|%s)",
        category="Tampering",
        cwe_id="CWE-22",
        description="File path constructed with user input",
        severity="high",
    ),
    VulnerabilityPattern(
        name="XSS via Template",
        pattern=r"\|\s*safe\b|Markup\s*\(|\.html\s*\(",
        category="Tampering",
        cwe_id="CWE-79",
        description="Unescaped HTML output in templates",
        severity="high",
    ),
    VulnerabilityPattern(
        name="LDAP Injection",
        pattern=r"(?:ldap|ldap3).*(?:search|bind).*(?:\+|\.format|%)",
        category="Tampering",
        cwe_id="CWE-90",
        description="LDAP query constructed with user input",
        severity="high",
    ),
    VulnerabilityPattern(
        name="XML External Entity",
        pattern=r"(?:etree\.parse|xml\.parse|parseString)\s*\([^)]*(?:resolve_entities|no_network)\s*=\s*False",
        category="Tampering",
        cwe_id="CWE-611",
        description="XML parsing with external entities enabled",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Code Injection via Eval",
        pattern=r"\b(?:eval|exec|compile)\s*\(\s*f['\"]|\b(?:eval|exec|compile)\s*\([^)]*(?:\+|\.format|%|request\.|input\()",
        category="Tampering",
        cwe_id="CWE-94",
        description="Dynamic code execution with user input",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="XSS via render_template_string",
        pattern=r"render_template_string\s*\(\s*f['\"]|render_template_string\s*\([^)]*(?:\+|\.format|%)",
        category="Tampering",
        cwe_id="CWE-79",
        description="Template rendered with user-controlled content",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="CSRF Protection Disabled",
        pattern=r"WTF_CSRF_ENABLED\s*=\s*False|csrf\.exempt|@csrf_exempt",
        category="Tampering",
        cwe_id="CWE-352",
        description="CSRF protection explicitly disabled",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Open Redirect",
        pattern=r"(?:redirect|HttpResponseRedirect|RedirectResponse)\s*\(\s*(?:request\.|f['\"]|[^)]*\+)",
        category="Tampering",
        cwe_id="CWE-601",
        description="Redirect to user-controlled URL",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="NoSQL Injection",
        pattern=r"(?:find|find_one|update|delete|aggregate)\s*\(\s*\{[^}]*(?:request\.|user\.|data\[|\$where)",
        category="Tampering",
        cwe_id="CWE-943",
        description="NoSQL query with user-controlled input",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Clickjacking Unprotected",
        pattern=r"X_FRAME_OPTIONS\s*=\s*(?:None|['\"]['\"])|X-Frame-Options.*ALLOWALL",
        category="Tampering",
        cwe_id="CWE-1021",
        description="Missing or disabled clickjacking protection",
        severity="medium",
    ),
]

# Repudiation patterns - missing audit logging, unsigned transactions
REPUDIATION_PATTERNS: list[VulnerabilityPattern] = [
    VulnerabilityPattern(
        name="Missing Audit Logging",
        pattern=r"def\s+(?:delete|update|create|modify|remove)\w*\s*\([^)]*\):[^}]*?(?!logger\.|logging\.|\.log\(|audit)",
        category="Repudiation",
        cwe_id="CWE-778",
        description="Critical operation without audit logging",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Sensitive Data in Logs",
        pattern=r"(?:logger|logging)\.\w+\s*\([^)]*(?:password|token|secret|key|credential)",
        category="Repudiation",
        cwe_id="CWE-532",
        description="Sensitive information written to logs",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Log Injection",
        pattern=r"(?:logger|logging)\.\w+\s*\([^)]*(?:\%|\.format|\+)\s*(?:\(|request\.|user)",
        category="Repudiation",
        cwe_id="CWE-117",
        description="Log message constructed with unvalidated input",
        severity="medium",
    ),
]

# Information Disclosure patterns - hardcoded secrets, sensitive data exposure
INFO_DISCLOSURE_PATTERNS: list[VulnerabilityPattern] = [
    VulnerabilityPattern(
        name="Hardcoded API Key",
        pattern=r"(?:api_key|apikey|api-key|API_KEY)\s*[=:]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]",
        category="InfoDisclosure",
        cwe_id="CWE-798",
        description="Hardcoded API key in source code",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Hardcoded Secret Key",
        pattern=r"(?:secret_key|SECRET_KEY|private_key|PRIVATE_KEY)\s*[=:]\s*['\"][^'\"]{10,}['\"]",
        category="InfoDisclosure",
        cwe_id="CWE-798",
        description="Hardcoded secret/private key in source code",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Verbose Error Messages",
        pattern=r"(?:traceback\.print_exc|raise\s+\w+Error\([^)]*(?:request|user|input))",
        category="InfoDisclosure",
        cwe_id="CWE-209",
        description="Detailed error messages exposed to users",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Debug Mode Enabled",
        pattern=r"(?:DEBUG\s*=\s*True|app\.debug\s*=\s*True|debug\s*=\s*True)",
        category="InfoDisclosure",
        cwe_id="CWE-215",
        description="Debug mode enabled in configuration",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Cleartext Password Storage",
        pattern=r"(?:password|passwd)\s*=\s*(?:request\.|form\[|data\[)",
        category="InfoDisclosure",
        cwe_id="CWE-312",
        description="Password stored or transmitted in cleartext",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Weak Cryptography",
        pattern=r"(?:MD5|SHA1|DES|RC4)\s*\(|hashlib\.(?:md5|sha1)\s*\(",
        category="InfoDisclosure",
        cwe_id="CWE-327",
        description="Use of weak cryptographic algorithm",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Cookie Missing Secure Flag",
        pattern=r"set_cookie\s*\([^)]*(?!secure\s*=\s*True)[^)]*\)|SESSION_COOKIE_SECURE\s*=\s*False",
        category="InfoDisclosure",
        cwe_id="CWE-614",
        description="Cookie set without Secure flag",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Cookie Missing HttpOnly Flag",
        pattern=r"set_cookie\s*\([^)]*(?!httponly\s*=\s*True)[^)]*\)|SESSION_COOKIE_HTTPONLY\s*=\s*False",
        category="InfoDisclosure",
        cwe_id="CWE-1004",
        description="Cookie set without HttpOnly flag",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Cookie Missing SameSite",
        pattern=r"SESSION_COOKIE_SAMESITE\s*=\s*(?:None|['\"]None['\"])",
        category="InfoDisclosure",
        cwe_id="CWE-1275",
        description="Cookie set without SameSite attribute",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Hardcoded Internal IP",
        pattern=r"['\"](?:192\.168\.|10\.|172\.(?:1[6-9]|2[0-9]|3[01])\.)\d{1,3}\.\d{1,3}['\"]",
        category="InfoDisclosure",
        cwe_id="CWE-547",
        description="Hardcoded internal IP address",
        severity="low",
    ),
]

# DoS patterns - resource exhaustion, uncontrolled recursion, regex DoS
DOS_PATTERNS: list[VulnerabilityPattern] = [
    VulnerabilityPattern(
        name="Regex DoS",
        pattern=r"re\.(?:match|search|findall)\s*\(['\"][^'\"]*(?:\+\+|\*\*|\{\d+,\})",
        category="DoS",
        cwe_id="CWE-1333",
        description="Regular expression vulnerable to catastrophic backtracking",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Unbounded Path Read",
        pattern=r"\.read_text\s*\(\s*\)|\.read_bytes\s*\(\s*\)",
        category="DoS",
        cwe_id="CWE-400",
        description="Path read without size limit",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Unbounded File Read",
        pattern=r"(?<![a-zA-Z_])(?:f|fp|file|fh|handle|infile|outfile|fd)\s*\.\s*read\s*\(\s*\)",
        category="DoS",
        cwe_id="CWE-400",
        description="File read without size limit",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Unbounded Readlines",
        pattern=r"\.readlines\s*\(\s*\)",
        category="DoS",
        cwe_id="CWE-400",
        description="Reading all lines without limit",
        severity="medium",
    ),
    VulnerabilityPattern(
        name="Uncontrolled Resource Allocation",
        pattern=r"range\s*\(\s*(?:request\.|user\.|int\s*\()",
        category="DoS",
        cwe_id="CWE-400",
        description="Resource allocation controlled by user input",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Missing Rate Limiting",
        pattern=r"@app\.route\([^)]+\)\s*\n(?:(?!@rate_limit|@limiter|@throttle).*\n)*def\s+\w+",
        category="DoS",
        cwe_id="CWE-770",
        description="API endpoint without rate limiting",
        severity="medium",
    ),
]

# Elevation of Privilege patterns - privilege escalation, insecure deserialization
EOP_PATTERNS: list[VulnerabilityPattern] = [
    VulnerabilityPattern(
        name="Insecure Deserialization",
        pattern=r"(?:pickle\.loads?|yaml\.load|yaml\.unsafe_load|marshal\.loads?)\s*\(",
        category="EoP",
        cwe_id="CWE-502",
        description="Deserialization of untrusted data",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Missing Authorization Check",
        pattern=r"def\s+(?:admin|delete|update|modify)\w*\s*\([^)]*\):[^}]*?(?!@admin_required|@requires_admin|\.is_admin|has_permission)",
        category="EoP",
        cwe_id="CWE-862",
        description="Administrative function without authorization check",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Privilege Escalation via Role",
        pattern=r"(?:role|is_admin|is_superuser)\s*=\s*(?:request\.|form\[|data\[)",
        category="EoP",
        cwe_id="CWE-284",
        description="User role set from untrusted input",
        severity="critical",
    ),
    VulnerabilityPattern(
        name="Mass Assignment",
        pattern=r"\.update\s*\(\s*\*\*(?:request\.|data|kwargs)",
        category="EoP",
        cwe_id="CWE-915",
        description="Object attributes updated from untrusted input",
        severity="high",
    ),
    VulnerabilityPattern(
        name="SSRF Vulnerability",
        pattern=r"(?:requests\.get|urllib\.request\.urlopen|httpx\.get)\s*\([^)]*(?:request\.|user\.|data\[)",
        category="EoP",
        cwe_id="CWE-918",
        description="Server-side request with user-controlled URL",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Running as Root",
        pattern=r"(?:setuid\s*\(\s*0|os\.setuid\s*\(\s*0|sudo|as_root\s*=\s*True)",
        category="EoP",
        cwe_id="CWE-250",
        description="Code execution with elevated privileges",
        severity="high",
    ),
    VulnerabilityPattern(
        name="Unsafe YAML Load",
        pattern=r"yaml\.load\s*\([^)]*(?!Loader\s*=\s*(?:yaml\.)?SafeLoader)",
        category="EoP",
        cwe_id="CWE-502",
        description="YAML load without safe Loader specified",
        severity="critical",
    ),
]


class PatternRegistry:
    """Registry of vulnerability patterns organized by STRIDE category.

    Provides access to predefined vulnerability patterns for code review.
    """

    def __init__(self) -> None:
        """Initialize the registry with predefined patterns."""
        self._patterns: dict[str, list[VulnerabilityPattern]] = {
            "Spoofing": SPOOFING_PATTERNS,
            "Tampering": TAMPERING_PATTERNS,
            "Repudiation": REPUDIATION_PATTERNS,
            "InfoDisclosure": INFO_DISCLOSURE_PATTERNS,
            "DoS": DOS_PATTERNS,
            "EoP": EOP_PATTERNS,
        }

    def get_patterns_for_category(self, category: str) -> list[VulnerabilityPattern]:
        """Get vulnerability patterns for a specific STRIDE category.

        Args:
            category: The STRIDE category (Spoofing, Tampering, etc.).

        Returns:
            List of VulnerabilityPattern objects for that category.
        """
        return self._patterns.get(category, [])

    def get_all_patterns(self) -> list[VulnerabilityPattern]:
        """Get all vulnerability patterns from the registry.

        Returns:
            List of all VulnerabilityPattern objects.
        """
        all_patterns: list[VulnerabilityPattern] = []
        for patterns in self._patterns.values():
            all_patterns.extend(patterns)
        return all_patterns
